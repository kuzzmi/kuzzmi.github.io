{"pageProps":{"post":{"html":"<p><code>iframe</code>. This word forces me to wake up at night in a cold sweat.</p>\n<p>On my current project we're using iframes everywhere. This is changing, but you cannot change everything at once. We are using iframes for displaying standalone pages inside a \"master\" page.</p>\n<h2 id=\"thepain\">The Pain</h2>\n<p>The whole messaging between the master page (MP) and iframes is done by using <code>window.postMessage</code>. This is why when MP sends a message, it has to know the recipient. But once I had to implement a new <em>cool suppa-duppa feature</em>. This feature required MP to send messages to unknown recipients. After initial thinking about implementation, I realized that this is not going to work. Especially if the iframe that had to do something with a message is not yet available in context of MP.</p>\n<blockquote>\n  <p><strong>7.2.3 Posting messages</strong></p>\n<pre><code class=\"hljs\">window.post<span class=\"hljs-constructor\">Message(<span class=\"hljs-params\">message</span>, [<span class=\"hljs-params\">ports</span>,] <span class=\"hljs-params\">targetOrigin</span>)</span>\n</code></pre>\n  <p>Posts a message, optionally with an array of ports, to the <strong>given window</strong>.</p>\n  <p>-- <strong><a href=\"https://www.w3.org/TR/2009/WD-html5-20090423/comms.html\">www.w3.org</a></strong></p>\n</blockquote>\n<h2 id=\"thedream\">The Dream</h2>\n<p>More and more often I'm trying to solve problems by dreaming about the best possible solution first. And then I go back from Z to A, from the solution to the problem. This is one of the principles of <a href=\"https://en.wikipedia.org/wiki/TRIZ\">TRIZ</a>. In this case I was thinking about the next solution:</p>\n<ol>\n<li>MP has to send a message and forget about it</li>\n<li>Unknown recipient should know about the message regardless of being present in the context of MP at the time of sending.</li>\n<li>After inserting recipient to the context, it has to react on old message and handle new ones.</li>\n</ol>\n<h2 id=\"thesolution\">The Solution</h2>\n<p>Fortunately, I know that all recipients and MP will always be on the same domain. This knowledge helped me to find the end solution.</p>\n<p>So, if we start from the end, we know that an iframe has to receive the old message even if it was inserted after the message had been sent. That means, that the data should be stored in the place which is accessible from MP and from iframes. And this place is a local storage. If we refer to specification:</p>\n<blockquote>\n  <p><strong>4.3 The localStorage attribute</strong></p>\n  <p>The localStorage object provides a Storage object for an <strong>origin</strong>.</p>\n  <p>â€¦</p>\n  <p>-- <strong><a href=\"https://www.w3.org/TR/webstorage/#dom-localstorage\">www.w3.org</a></strong></p>\n</blockquote>\n<p>This is perfect. This is absolutely perfect place for storing the old message, but how will we know that there is a new message? If we read the section 4.2 from <a href=\"https://www.w3.org/TR/webstorage/#the-sessionstorage-attribute\">www.w3.org</a>:</p>\n<blockquote>\n  <p><strong>4.2 The sessionStorage attribute</strong></p>\n  <p>When the setItem(), removeItem(), and clear() methods are called on a <strong>Storage object x</strong> that is associated with a session storage area, â€¦, then for every Document object whose Window object's sessionStorage attribute's Storage object is associated with the same storage area, <strong>other than x</strong>, send a storage notification.</p>\n  <p>-- <strong><a href=\"https://www.w3.org/TR/webstorage/#the-sessionstorage-attribute\">www.w3.org</a></strong></p>\n</blockquote>\n<p>â€¦we'll find out that we can handle changes in children by attaching to the <code>storage</code> event:</p>\n<pre class=\"javascript language-javascript\"><code class=\"hljs javascript language-javascript\"><span class=\"hljs-variable language_\">window</span>.<span class=\"hljs-title function_\">addEventListener</span>(<span class=\"hljs-string\">&#x27;storage&#x27;</span>, handleEvent);\n</code></pre>\n<p>So now, if we write this inside iframes, all the iframes will be notified about changes in the localStorage, thus they can react on new events in the same way as on old messages.</p>\n<p>So, let's say, that we need to broadcast <code>foobar</code> message which just fires some alert:</p>\n<pre class=\"javascript language-javascript\"><code class=\"hljs javascript language-javascript\"><span class=\"hljs-comment\">// Master page</span>\n<span class=\"hljs-keyword\">let</span> storage = <span class=\"hljs-variable language_\">window</span>.<span class=\"hljs-property\">localStorage</span>;\n\n<span class=\"hljs-built_in\">setInterval</span>(<span class=\"hljs-function\">() =&gt;</span> {\n    storage.<span class=\"hljs-title function_\">setItem</span>(<span class=\"hljs-string\">&#x27;$messages.foobar&#x27;</span>, <span class=\"hljs-string\">&#x27;true&#x27;</span>); <span class=\"hljs-comment\">// let&#x27;s use a namespace for messages</span>\n}, <span class=\"hljs-number\">1000</span>);\n</code></pre>\n<p>Then in an iframe:</p>\n<pre class=\"javascript language-javascript\"><code class=\"hljs javascript language-javascript\"><span class=\"hljs-comment\">// An iframe</span>\n<span class=\"hljs-keyword\">const</span> <span class=\"hljs-variable constant_\">MESSAGE</span> = <span class=\"hljs-string\">&#x27;$messages.foobar&#x27;</span>;\n<span class=\"hljs-keyword\">let</span> storage = <span class=\"hljs-variable language_\">window</span>.<span class=\"hljs-property\">localStorage</span>;\n\n<span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">handleEvent</span>(<span class=\"hljs-params\"></span>) {\n <span class=\"hljs-keyword\">let</span> message = storage.<span class=\"hljs-title function_\">getItem</span>(<span class=\"hljs-variable constant_\">MESSAGE</span>);\n    <span class=\"hljs-keyword\">if</span> (message) {\n        <span class=\"hljs-title function_\">alert</span>(<span class=\"hljs-string\">&#x27;foobar&#x27;</span>);\n        storage.<span class=\"hljs-title function_\">removeItem</span>(<span class=\"hljs-variable constant_\">MESSAGE</span>);\n    }\n}\n\n<span class=\"hljs-title function_\">handleEvent</span>(); <span class=\"hljs-comment\">// reacts on old message</span>\n<span class=\"hljs-variable language_\">window</span>.<span class=\"hljs-title function_\">addEventListener</span>(<span class=\"hljs-string\">&#x27;storage&#x27;</span>, handleEvent); <span class=\"hljs-comment\">// handles new messages</span>\n</code></pre>\n<p>After that we can open the master page without any iframes, insert one with the code above and it will immediately alert \"foobar\" and then will do this every second.</p>\n<p>That's it.</p>\n<p>If you have any comments or suggestions, please let <a href=\"http://twitter.com/kuzzmi\">me know</a>.</p>","type":"blog","meta":{"slug":"deferred-messaging-using-localstorage","title":"Deferred Messaging Using localStorage","layout":"post","lang":"en","description":"In this post I will describe the way how I have solved a tricky problem to broadcast deferred messages to unknown iframes from parent window on the same domain using localStorage.,\n","tags":["technology","javascript","html","tips"],"date":"2016-03-07T14:16:31Z"}},"_nextI18Next":{"initialI18nStore":{"en":{"common":{"common":{"name":"Igor Kuzmenko","version":"version","articleFooter":"If you enjoyed the reading, you can tip me <a href=\"https://fundof.me/igor?tip\" target=\"_blank\" rel=\"noreferrer\">here</a> ðŸ˜‰","articleNotAvailable":"This content is available only in Ukrainian."},"menu":{"home":"Home","blog":"Tech articles","thoughts":"Thoughts","podcast":"Podcast","projects":"Projects","about":"About me"},"home":{"meta":{"description":"Home page of Igor Kuzmenko"},"bio":"developer and tech entrepreneur","read":"Read","recents":"Recent publications","description":{"part_1":"Here I publish ","part_2":"my thoughts","part_3":" and ","part_4":" tech articles","part_5":". Avid Linux and vim user. Co-founder at "}},"blog":{"description":"Different findings in the tech world that I want to share with world."},"thoughts":{"description":"My thoughts about life and work in Ukrainian."},"about":{"body":"Hi ðŸ‘‹<br /><br />My name is Igor Kuzmenko. I love my wife, son, dog and cat. And I love making things up and making them real (but more often this doesn't happen).<br /><br />For a long time, my personal page seemed like an official paper with a bunch of clichÃ©s, so I got sick of it and turned it into something what feels more like me and my approach to life: a combination of lightness, aesthetics, some seriousness and humor (and modesty).<br /><br />I spend my spare time with my family, doing pet projects, playing video games and more: from playing the ukulele and drawing, to electrical engineering and sports car driving.<br /><br />I've tried countless times to increase my online presence, but it never lasts long ðŸ™ƒ<br /><br />My social networks and contacts are available here: <a href=\"https://fundof.me/igor\">fundof.me/igor</a>"}}}},"initialLocale":"en","userConfig":{"i18n":{"defaultLocale":"en","locales":["en","ua"]},"default":{"i18n":{"defaultLocale":"en","locales":["en","ua"]}}}}},"__N_SSG":true}