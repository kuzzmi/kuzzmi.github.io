<!DOCTYPE html><html lang="en"><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>Deferred Messaging Using localStorage | Tech articles | Igor Kuzmenko</title><meta name="robots" content="index,follow"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:creator" content="@kuzzmi"/><meta property="og:title" content="Deferred Messaging Using localStorage"/><meta property="og:description" content="In this post I will describe the way how I have solved a tricky problem to broadcast deferred messages to unknown iframes from parent window on the same domain using localStorage.,
"/><meta property="og:url" content="https://kuzzmi.com/en/blog/deferred-messaging-using-localstorage/"/><meta property="og:type" content="article"/><meta property="article:published_time" content="2016-03-07 14:16:31 +0200"/><meta property="article:author" content="https://kuzzmi.com/about"/><meta property="article:tag" content="technology"/><meta property="article:tag" content="javascript"/><meta property="article:tag" content="html"/><meta property="article:tag" content="tips"/><link rel="canonical" href="https://kuzzmi.com/en/blog/deferred-messaging-using-localstorage/"/><meta name="next-head-count" content="17"/><link rel="dns-prefetch" href="https://www.googleapis.com"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"/><link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png"/><link rel="manifest" href="/static/site.webmanifest"/><link rel="shortcut icon" href="/static/favicon.ico" type="image/x-icon"/><meta name="apple-mobile-web-app-capable" content="yes"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.0/styles/base16/railscasts.min.css"/><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.0/highlight.min.js"></script><meta name="author" content="Igor Kuzmenko"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin /><link rel="preload" href="/_next/static/css/8d3077ef275150e2.css" as="style"/><link rel="stylesheet" href="/_next/static/css/8d3077ef275150e2.css" data-n-g=""/><link rel="preload" href="/_next/static/css/5efee9f793991289.css" as="style"/><link rel="stylesheet" href="/_next/static/css/5efee9f793991289.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-69bfa6990bb9e155.js" defer=""></script><script src="/_next/static/chunks/framework-fc97f3f1282ce3ed.js" defer=""></script><script src="/_next/static/chunks/main-fca90e9fb8aa5e83.js" defer=""></script><script src="/_next/static/chunks/pages/_app-84072d5e9d49e694.js" defer=""></script><script src="/_next/static/chunks/47-1461360545d2f08c.js" defer=""></script><script src="/_next/static/chunks/962-41b19898a46b0b4f.js" defer=""></script><script src="/_next/static/chunks/pages/%5Blocale%5D/blog/%5Bslug%5D-2f15bd0a4df51c76.js" defer=""></script><script src="/_next/static/hxj8Fa6FWS5vOfkqB0Ds1/_buildManifest.js" defer=""></script><script src="/_next/static/hxj8Fa6FWS5vOfkqB0Ds1/_ssgManifest.js" defer=""></script><script src="/_next/static/hxj8Fa6FWS5vOfkqB0Ds1/_middlewareManifest.js" defer=""></script><style data-href="https://fonts.googleapis.com/css2?family=JetBrains+Mono&family=PT+Sans:ital,wght@0,400;0,700;1,400&display=swap">@font-face{font-family:'JetBrains Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/jetbrainsmono/v11/tDbY2o-flEEny0FZhsfKu5WU4zr3E_BX0PnT8RD8yKxjPg.woff) format('woff')}@font-face{font-family:'PT Sans';font-style:italic;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ptsans/v16/jizYRExUiTo99u79D0eEww.woff) format('woff')}@font-face{font-family:'PT Sans';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ptsans/v16/jizaRExUiTo99u79P0Y.woff) format('woff')}@font-face{font-family:'PT Sans';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/ptsans/v16/jizfRExUiTo99u79B_mh4Oo.woff) format('woff')}@font-face{font-family:'JetBrains Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/jetbrainsmono/v11/tDbY2o-flEEny0FZhsfKu5WU4zr3E_BX0PnT8RD8yKxTN1OTk6OThhvAWV8.woff) format('woff');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'JetBrains Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/jetbrainsmono/v11/tDbY2o-flEEny0FZhsfKu5WU4zr3E_BX0PnT8RD8yKxTPlOTk6OThhvAWV8.woff) format('woff');unicode-range:U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'JetBrains Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/jetbrainsmono/v11/tDbY2o-flEEny0FZhsfKu5WU4zr3E_BX0PnT8RD8yKxTOVOTk6OThhvAWV8.woff) format('woff');unicode-range:U+0370-03FF}@font-face{font-family:'JetBrains Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/jetbrainsmono/v11/tDbY2o-flEEny0FZhsfKu5WU4zr3E_BX0PnT8RD8yKxTNVOTk6OThhvAWV8.woff) format('woff');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+1EA0-1EF9,U+20AB}@font-face{font-family:'JetBrains Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/jetbrainsmono/v11/tDbY2o-flEEny0FZhsfKu5WU4zr3E_BX0PnT8RD8yKxTNFOTk6OThhvAWV8.woff) format('woff');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'JetBrains Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/jetbrainsmono/v11/tDbY2o-flEEny0FZhsfKu5WU4zr3E_BX0PnT8RD8yKxTOlOTk6OThhvA.woff) format('woff');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'PT Sans';font-style:italic;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ptsans/v16/jizYRExUiTo99u79D0e0ysmIAjcQ-woy.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'PT Sans';font-style:italic;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ptsans/v16/jizYRExUiTo99u79D0e0w8mIAjcQ-woy.woff2) format('woff2');unicode-range:U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'PT Sans';font-style:italic;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ptsans/v16/jizYRExUiTo99u79D0e0ycmIAjcQ-woy.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'PT Sans';font-style:italic;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ptsans/v16/jizYRExUiTo99u79D0e0x8mIAjcQ-w.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'PT Sans';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ptsans/v16/jizaRExUiTo99u79D0-ExcOPIDUg-g.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'PT Sans';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ptsans/v16/jizaRExUiTo99u79D0aExcOPIDUg-g.woff2) format('woff2');unicode-range:U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'PT Sans';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ptsans/v16/jizaRExUiTo99u79D0yExcOPIDUg-g.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'PT Sans';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ptsans/v16/jizaRExUiTo99u79D0KExcOPIDU.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'PT Sans';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/ptsans/v16/jizfRExUiTo99u79B_mh0OOtLR8a8zILig.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'PT Sans';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/ptsans/v16/jizfRExUiTo99u79B_mh0OqtLR8a8zILig.woff2) format('woff2');unicode-range:U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'PT Sans';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/ptsans/v16/jizfRExUiTo99u79B_mh0OCtLR8a8zILig.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'PT Sans';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/ptsans/v16/jizfRExUiTo99u79B_mh0O6tLR8a8zI.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}</style></head><body><div id="__next"><main class="PageLayout_page_container__M8QGN "><menu class="PageLayout_menu_container__La6NU"><ul><li class="PageLayout_inactive__g2bTn"><a href="/en/">Home</a></li><li><a href="/en/blog/">Tech articles</a></li><li class="PageLayout_inactive__g2bTn"><a href="/en/thoughts/">Thoughts</a></li><li class="PageLayout_inactive__g2bTn"><a href="/en/about/">About me</a></li></ul></menu><section class="PageLayout_content_container__1IMZI"><header class="PageLayout_header_container__Y6dbq"><div><div class="PageLayout_menu_button__vWi4y"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24px" height="24px"><path fill="none" stroke="#000000" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M3 12L21 12M3 6L21 6M3 18L21 18"></path></svg></div><p class="PageLayout_name__xhUaP"></p></div><div class="PageLayout_lang_switcher___L3bH"><p class="PageLayout_version__2_iha">version<!-- -->:<!-- --></p><div class="PageLayout_langs__z_SxD"><a class="" href="/ua/blog/deferred-messaging-using-localstorage/">🇺🇦</a><a class="PageLayout_active__UxQoO" href="/en/blog/deferred-messaging-using-localstorage/">🇬🇧</a></div></div></header><article class="PageLayout_content__6Pdc3"><div class="Post_container__jmeoa"><h1>Deferred Messaging Using localStorage</h1><p class="Post_date__B7bMG">3/7/2016, 2:16:31 PM</p><div><p><code>iframe</code>. This word forces me to wake up at night in a cold sweat.</p>
<p>On my current project we're using iframes everywhere. This is changing, but you cannot change everything at once. We are using iframes for displaying standalone pages inside a "master" page.</p>
<h2 id="thepain">The Pain</h2>
<p>The whole messaging between the master page (MP) and iframes is done by using <code>window.postMessage</code>. This is why when MP sends a message, it has to know the recipient. But once I had to implement a new <em>cool suppa-duppa feature</em>. This feature required MP to send messages to unknown recipients. After initial thinking about implementation, I realized that this is not going to work. Especially if the iframe that had to do something with a message is not yet available in context of MP.</p>
<blockquote>
  <p><strong>7.2.3 Posting messages</strong></p>
<pre><code class="hljs">window.post<span class="hljs-constructor">Message(<span class="hljs-params">message</span>, [<span class="hljs-params">ports</span>,] <span class="hljs-params">targetOrigin</span>)</span>
</code></pre>
  <p>Posts a message, optionally with an array of ports, to the <strong>given window</strong>.</p>
  <p>-- <strong><a href="https://www.w3.org/TR/2009/WD-html5-20090423/comms.html">www.w3.org</a></strong></p>
</blockquote>
<h2 id="thedream">The Dream</h2>
<p>More and more often I'm trying to solve problems by dreaming about the best possible solution first. And then I go back from Z to A, from the solution to the problem. This is one of the principles of <a href="https://en.wikipedia.org/wiki/TRIZ">TRIZ</a>. In this case I was thinking about the next solution:</p>
<ol>
<li>MP has to send a message and forget about it</li>
<li>Unknown recipient should know about the message regardless of being present in the context of MP at the time of sending.</li>
<li>After inserting recipient to the context, it has to react on old message and handle new ones.</li>
</ol>
<h2 id="thesolution">The Solution</h2>
<p>Fortunately, I know that all recipients and MP will always be on the same domain. This knowledge helped me to find the end solution.</p>
<p>So, if we start from the end, we know that an iframe has to receive the old message even if it was inserted after the message had been sent. That means, that the data should be stored in the place which is accessible from MP and from iframes. And this place is a local storage. If we refer to specification:</p>
<blockquote>
  <p><strong>4.3 The localStorage attribute</strong></p>
  <p>The localStorage object provides a Storage object for an <strong>origin</strong>.</p>
  <p>…</p>
  <p>-- <strong><a href="https://www.w3.org/TR/webstorage/#dom-localstorage">www.w3.org</a></strong></p>
</blockquote>
<p>This is perfect. This is absolutely perfect place for storing the old message, but how will we know that there is a new message? If we read the section 4.2 from <a href="https://www.w3.org/TR/webstorage/#the-sessionstorage-attribute">www.w3.org</a>:</p>
<blockquote>
  <p><strong>4.2 The sessionStorage attribute</strong></p>
  <p>When the setItem(), removeItem(), and clear() methods are called on a <strong>Storage object x</strong> that is associated with a session storage area, …, then for every Document object whose Window object's sessionStorage attribute's Storage object is associated with the same storage area, <strong>other than x</strong>, send a storage notification.</p>
  <p>-- <strong><a href="https://www.w3.org/TR/webstorage/#the-sessionstorage-attribute">www.w3.org</a></strong></p>
</blockquote>
<p>…we'll find out that we can handle changes in children by attaching to the <code>storage</code> event:</p>
<pre class="javascript language-javascript"><code class="hljs javascript language-javascript"><span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;storage&#x27;</span>, handleEvent);
</code></pre>
<p>So now, if we write this inside iframes, all the iframes will be notified about changes in the localStorage, thus they can react on new events in the same way as on old messages.</p>
<p>So, let's say, that we need to broadcast <code>foobar</code> message which just fires some alert:</p>
<pre class="javascript language-javascript"><code class="hljs javascript language-javascript"><span class="hljs-comment">// Master page</span>
<span class="hljs-keyword">let</span> storage = <span class="hljs-variable language_">window</span>.<span class="hljs-property">localStorage</span>;

<span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
    storage.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">&#x27;$messages.foobar&#x27;</span>, <span class="hljs-string">&#x27;true&#x27;</span>); <span class="hljs-comment">// let&#x27;s use a namespace for messages</span>
}, <span class="hljs-number">1000</span>);
</code></pre>
<p>Then in an iframe:</p>
<pre class="javascript language-javascript"><code class="hljs javascript language-javascript"><span class="hljs-comment">// An iframe</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MESSAGE</span> = <span class="hljs-string">&#x27;$messages.foobar&#x27;</span>;
<span class="hljs-keyword">let</span> storage = <span class="hljs-variable language_">window</span>.<span class="hljs-property">localStorage</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleEvent</span>(<span class="hljs-params"></span>) {
 <span class="hljs-keyword">let</span> message = storage.<span class="hljs-title function_">getItem</span>(<span class="hljs-variable constant_">MESSAGE</span>);
    <span class="hljs-keyword">if</span> (message) {
        <span class="hljs-title function_">alert</span>(<span class="hljs-string">&#x27;foobar&#x27;</span>);
        storage.<span class="hljs-title function_">removeItem</span>(<span class="hljs-variable constant_">MESSAGE</span>);
    }
}

<span class="hljs-title function_">handleEvent</span>(); <span class="hljs-comment">// reacts on old message</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;storage&#x27;</span>, handleEvent); <span class="hljs-comment">// handles new messages</span>
</code></pre>
<p>After that we can open the master page without any iframes, insert one with the code above and it will immediately alert "foobar" and then will do this every second.</p>
<p>That's it.</p>
<p>If you have any comments or suggestions, please let <a href="http://twitter.com/kuzzmi">me know</a>.</p></div><div class="Post_footer__JGzaD">If you enjoyed the reading, you can tip me <a href="https://fundof.me/kuzzmi?tip" target="_blank" rel="noreferrer">here</a> 😉</div></div></article></section><div class="PageLayout_flag__XuZGa"><div class="PageLayout_blue__CUemv"></div><div class="PageLayout_yellow__R8WIm"></div></div></main></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"html":"\u003cp\u003e\u003ccode\u003eiframe\u003c/code\u003e. This word forces me to wake up at night in a cold sweat.\u003c/p\u003e\n\u003cp\u003eOn my current project we're using iframes everywhere. This is changing, but you cannot change everything at once. We are using iframes for displaying standalone pages inside a \"master\" page.\u003c/p\u003e\n\u003ch2 id=\"thepain\"\u003eThe Pain\u003c/h2\u003e\n\u003cp\u003eThe whole messaging between the master page (MP) and iframes is done by using \u003ccode\u003ewindow.postMessage\u003c/code\u003e. This is why when MP sends a message, it has to know the recipient. But once I had to implement a new \u003cem\u003ecool suppa-duppa feature\u003c/em\u003e. This feature required MP to send messages to unknown recipients. After initial thinking about implementation, I realized that this is not going to work. Especially if the iframe that had to do something with a message is not yet available in context of MP.\u003c/p\u003e\n\u003cblockquote\u003e\n  \u003cp\u003e\u003cstrong\u003e7.2.3 Posting messages\u003c/strong\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs\"\u003ewindow.post\u003cspan class=\"hljs-constructor\"\u003eMessage(\u003cspan class=\"hljs-params\"\u003emessage\u003c/span\u003e, [\u003cspan class=\"hljs-params\"\u003eports\u003c/span\u003e,] \u003cspan class=\"hljs-params\"\u003etargetOrigin\u003c/span\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n  \u003cp\u003ePosts a message, optionally with an array of ports, to the \u003cstrong\u003egiven window\u003c/strong\u003e.\u003c/p\u003e\n  \u003cp\u003e-- \u003cstrong\u003e\u003ca href=\"https://www.w3.org/TR/2009/WD-html5-20090423/comms.html\"\u003ewww.w3.org\u003c/a\u003e\u003c/strong\u003e\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch2 id=\"thedream\"\u003eThe Dream\u003c/h2\u003e\n\u003cp\u003eMore and more often I'm trying to solve problems by dreaming about the best possible solution first. And then I go back from Z to A, from the solution to the problem. This is one of the principles of \u003ca href=\"https://en.wikipedia.org/wiki/TRIZ\"\u003eTRIZ\u003c/a\u003e. In this case I was thinking about the next solution:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eMP has to send a message and forget about it\u003c/li\u003e\n\u003cli\u003eUnknown recipient should know about the message regardless of being present in the context of MP at the time of sending.\u003c/li\u003e\n\u003cli\u003eAfter inserting recipient to the context, it has to react on old message and handle new ones.\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2 id=\"thesolution\"\u003eThe Solution\u003c/h2\u003e\n\u003cp\u003eFortunately, I know that all recipients and MP will always be on the same domain. This knowledge helped me to find the end solution.\u003c/p\u003e\n\u003cp\u003eSo, if we start from the end, we know that an iframe has to receive the old message even if it was inserted after the message had been sent. That means, that the data should be stored in the place which is accessible from MP and from iframes. And this place is a local storage. If we refer to specification:\u003c/p\u003e\n\u003cblockquote\u003e\n  \u003cp\u003e\u003cstrong\u003e4.3 The localStorage attribute\u003c/strong\u003e\u003c/p\u003e\n  \u003cp\u003eThe localStorage object provides a Storage object for an \u003cstrong\u003eorigin\u003c/strong\u003e.\u003c/p\u003e\n  \u003cp\u003e…\u003c/p\u003e\n  \u003cp\u003e-- \u003cstrong\u003e\u003ca href=\"https://www.w3.org/TR/webstorage/#dom-localstorage\"\u003ewww.w3.org\u003c/a\u003e\u003c/strong\u003e\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eThis is perfect. This is absolutely perfect place for storing the old message, but how will we know that there is a new message? If we read the section 4.2 from \u003ca href=\"https://www.w3.org/TR/webstorage/#the-sessionstorage-attribute\"\u003ewww.w3.org\u003c/a\u003e:\u003c/p\u003e\n\u003cblockquote\u003e\n  \u003cp\u003e\u003cstrong\u003e4.2 The sessionStorage attribute\u003c/strong\u003e\u003c/p\u003e\n  \u003cp\u003eWhen the setItem(), removeItem(), and clear() methods are called on a \u003cstrong\u003eStorage object x\u003c/strong\u003e that is associated with a session storage area, …, then for every Document object whose Window object's sessionStorage attribute's Storage object is associated with the same storage area, \u003cstrong\u003eother than x\u003c/strong\u003e, send a storage notification.\u003c/p\u003e\n  \u003cp\u003e-- \u003cstrong\u003e\u003ca href=\"https://www.w3.org/TR/webstorage/#the-sessionstorage-attribute\"\u003ewww.w3.org\u003c/a\u003e\u003c/strong\u003e\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e…we'll find out that we can handle changes in children by attaching to the \u003ccode\u003estorage\u003c/code\u003e event:\u003c/p\u003e\n\u003cpre class=\"javascript language-javascript\"\u003e\u003ccode class=\"hljs javascript language-javascript\"\u003e\u003cspan class=\"hljs-variable language_\"\u003ewindow\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eaddEventListener\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;storage\u0026#x27;\u003c/span\u003e, handleEvent);\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eSo now, if we write this inside iframes, all the iframes will be notified about changes in the localStorage, thus they can react on new events in the same way as on old messages.\u003c/p\u003e\n\u003cp\u003eSo, let's say, that we need to broadcast \u003ccode\u003efoobar\u003c/code\u003e message which just fires some alert:\u003c/p\u003e\n\u003cpre class=\"javascript language-javascript\"\u003e\u003ccode class=\"hljs javascript language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// Master page\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e storage = \u003cspan class=\"hljs-variable language_\"\u003ewindow\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003elocalStorage\u003c/span\u003e;\n\n\u003cspan class=\"hljs-built_in\"\u003esetInterval\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e() =\u0026gt;\u003c/span\u003e {\n    storage.\u003cspan class=\"hljs-title function_\"\u003esetItem\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;$messages.foobar\u0026#x27;\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026#x27;true\u0026#x27;\u003c/span\u003e); \u003cspan class=\"hljs-comment\"\u003e// let\u0026#x27;s use a namespace for messages\u003c/span\u003e\n}, \u003cspan class=\"hljs-number\"\u003e1000\u003c/span\u003e);\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThen in an iframe:\u003c/p\u003e\n\u003cpre class=\"javascript language-javascript\"\u003e\u003ccode class=\"hljs javascript language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// An iframe\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-variable constant_\"\u003eMESSAGE\u003c/span\u003e = \u003cspan class=\"hljs-string\"\u003e\u0026#x27;$messages.foobar\u0026#x27;\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e storage = \u003cspan class=\"hljs-variable language_\"\u003ewindow\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003elocalStorage\u003c/span\u003e;\n\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003ehandleEvent\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e) {\n \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e message = storage.\u003cspan class=\"hljs-title function_\"\u003egetItem\u003c/span\u003e(\u003cspan class=\"hljs-variable constant_\"\u003eMESSAGE\u003c/span\u003e);\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (message) {\n        \u003cspan class=\"hljs-title function_\"\u003ealert\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;foobar\u0026#x27;\u003c/span\u003e);\n        storage.\u003cspan class=\"hljs-title function_\"\u003eremoveItem\u003c/span\u003e(\u003cspan class=\"hljs-variable constant_\"\u003eMESSAGE\u003c/span\u003e);\n    }\n}\n\n\u003cspan class=\"hljs-title function_\"\u003ehandleEvent\u003c/span\u003e(); \u003cspan class=\"hljs-comment\"\u003e// reacts on old message\u003c/span\u003e\n\u003cspan class=\"hljs-variable language_\"\u003ewindow\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eaddEventListener\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;storage\u0026#x27;\u003c/span\u003e, handleEvent); \u003cspan class=\"hljs-comment\"\u003e// handles new messages\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAfter that we can open the master page without any iframes, insert one with the code above and it will immediately alert \"foobar\" and then will do this every second.\u003c/p\u003e\n\u003cp\u003eThat's it.\u003c/p\u003e\n\u003cp\u003eIf you have any comments or suggestions, please let \u003ca href=\"http://twitter.com/kuzzmi\"\u003eme know\u003c/a\u003e.\u003c/p\u003e","type":"blog","meta":{"slug":"deferred-messaging-using-localstorage","title":"Deferred Messaging Using localStorage","layout":"post","lang":"en","description":"In this post I will describe the way how I have solved a tricky problem to broadcast deferred messages to unknown iframes from parent window on the same domain using localStorage.,\n","tags":["technology","javascript","html","tips"],"date":"2016-03-07 14:16:31 +0200"}},"_nextI18Next":{"initialI18nStore":{"en":{"common":{"common":{"name":"Igor Kuzmenko","version":"version","articleFooter":"If you enjoyed the reading, you can tip me \u003ca href=\"https://fundof.me/kuzzmi?tip\" target=\"_blank\" rel=\"noreferrer\"\u003ehere\u003c/a\u003e 😉","articleNotAvailable":"This content is available only in Ukrainian."},"menu":{"home":"Home","blog":"Tech articles","thoughts":"Thoughts","podcast":"Podcast","projects":"Projects","about":"About me"},"home":{"meta":{"description":"Home page of Igor Kuzmenko"},"bio":"developer and tech entrepreneur","read":"Read","recents":"Recent publications","description":{"part_1":"Here I publish ","part_2":"my thoughts","part_3":" and ","part_4":" tech articles","part_5":". Avid Linux and vim user. Co-founder at "}},"blog":{"description":"Different findings in the tech world that I want to share with world."},"thoughts":{"description":"My thoughts about life and work in Ukrainian."},"about":{"body":"Hi 👋\u003cbr /\u003e\u003cbr /\u003eMy name is Igor Kuzmenko. I love my wife, son, dog and cat. And I love making things up and making them real (but more often this doesn't happen).\u003cbr /\u003e\u003cbr /\u003eFor a long time, my personal page seemed like an official paper with a bunch of clichés, so I got sick of it and turned it into something what feels more like me and my approach to life: a combination of lightness, aesthetics, some seriousness and humor (and modesty).\u003cbr /\u003e\u003cbr /\u003eI spend my spare time with my family, doing pet projects, playing video games and more: from playing the ukulele and drawing, to electrical engineering and sports car driving.\u003cbr /\u003e\u003cbr /\u003eI've tried countless times to increase my online presence, but it never lasts long 🙃\u003cbr /\u003e\u003cbr /\u003eMy social networks and contacts are available here: \u003ca href=\"https://fundof.me/igor\"\u003efundof.me/igor\u003c/a\u003e"}}}},"initialLocale":"en","userConfig":{"i18n":{"defaultLocale":"en","locales":["en","ua"]},"default":{"i18n":{"defaultLocale":"en","locales":["en","ua"]}}}}},"__N_SSG":true},"page":"/[locale]/blog/[slug]","query":{"locale":"en","slug":"deferred-messaging-using-localstorage"},"buildId":"hxj8Fa6FWS5vOfkqB0Ds1","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>